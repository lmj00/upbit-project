{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="{% static 'simulated_trade/css/style.css' %}">
</head>
<body>
    <div id="market_list" style="cursor: default;"></div>

    <table border="1" style="margin-bottom: 20px;">
        <thead>
            <tr>
                <th>보유KRW</th>
                <th>총 보유자산</th>
                <th>총매수</th>
                <th>평가손익</th>
                <th>총평가</th>
                <th>수익률</th>
            </tr>
        </thead>
        <tbody id="t-body2">

        </tbody>
    </table>

    <table border="1" style="margin-bottom: 50px;">
        <thead>
            <tr>
                <th>이름</th>
                <th>보유수량</th>
                <th>매수평균가</th>
                <th>매수금액</th>
                <th>평가금액</th>
                <th>수익률</th>
            </tr>
        </thead>
        <tbody id="t-body">

        </tbody>
    </table>

    <form id="in_form">
        <div>
            <label for="in_name">이름</label>
            <input type="text" id="in_name" name="in_name"></input>
        </div>
        <div>
            <label for="in_price">가격(KRW)<label>
            <input type="text" id="in_price" name="in_price"></input>
        </div>
        <div>
            <label for="in_quantity">주문수량<label>
            <input type="text" id="in_quantity" name="in_quantity" value="0"></input>
        </div>
        <div>
            <label for="in_total">주문총액(KRW)<label>
            <input type="text" id="in_total" name="in_total" value="0"></input>
        </div>
        <a href="#" id="buyBtn">매수</a>
        <a href="#" id="sellBtn">매도</a>
    </form>


    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
        
        function order(event){
            event.preventDefault();
            
            const form = document.getElementById('in_form');
            const formData = new FormData(form);  
            const jsonData = {};


            for (let pair of formData.entries()) {
                jsonData[pair[0]] = pair[1];
            }
            
            const url = event.target.id === 'buyBtn' ? 'order/bid' : 'order/ask'
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken': csrftoken
                },

                body: JSON.stringify(jsonData)
            })

            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
            
            .catch(error => {
                alert("에러");
            });

        };
        
        document.getElementById('buyBtn').addEventListener('click', order);
        document.getElementById('sellBtn').addEventListener('click', order);


        var marketList = document.getElementById('market_list');
        
        // 코인 클릭
        marketList.addEventListener('click', function(event) {
            var target = event.target;
            var code = target.closest('.code');

            if (code) {
                var coinName = code.querySelector('.name').textContent;
                var coinPrice = code.querySelector('.price').textContent;

                var inputName = document.getElementById('in_name');
                inputName.value = coinName;

                var inputPrice = document.getElementById('in_price');
                inputPrice.value = parseFloat(coinPrice);
            }
        });

        // 코인 수량 입력
        var inputQuantity = document.getElementById('in_quantity');
        var inputPrice = document.getElementById('in_price');
        var inputTotal = document.getElementById('in_total');

        inputQuantity.addEventListener('input', function(event) {

            var quantity = parseFloat(event.target.value);
            var price = parseFloat(inputPrice.value);
            var total = quantity * price;

            inputTotal.value = isNaN(total) ? 0 : total.toLocaleString();
        });


        const socket = new WebSocket(
            'ws://' + window.location.host + '/ws/sml_trade/'
        );    
        

        function sendSignal() {
            socket.send(JSON.stringify({
                'signal': true,
            }));
        }

        let intervalId;

        socket.onopen = function(event) {
            intervalId = setInterval(sendSignal, 1000);
        }   

        socket.onclose = function(event) {
            clearInterval(intervalId);
        }
        

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type == 'ticker') {
                data.value.forEach(item => {
                    var code = document.getElementById(item.code);

                    if (!code) {
                        var code = document.createElement('div');
                        code.setAttribute('id', item.code)
                        code.setAttribute('class', 'code')

                        var name = document.createElement('span');
                        name.setAttribute('class', 'name');
                        name.textContent = item.name;

                        var price = document.createElement('span');
                        price.setAttribute('class', 'price');
                        price.textContent= item.trade_price;
                            
                        code.appendChild(name);
                        code.appendChild(price);
                        market_list.appendChild(code);
                    } else {

                    }
                });

            } else if(data.type == 'sml_account') {
                const tableBody = document.getElementById('t-body');
                let tableHTML = '';
                
                data.value.forEach(item => {
                    tableHTML += `
                        <tr>
                        <td>${item.name}</td>
                        <td>${item.balance}</td>
                        <td>${item.avg_buy_price}</td>
                        <td>${item.amount_money}</td>
                        <td>${item.valuation_amount}</td>
                        <td>${item.rate_of_return}</td>
                        </tr>
                    `;
                    });
                
                    tableBody.innerHTML = tableHTML;

            } else if (data.type == 'sml_account_balance') {
                const tableBody2 = document.getElementById('t-body2');
                const data_value = data.value;

                let tableHTML2 = '';
                
                tableHTML2 += `
                    <tr>
                        <td>${data_value[0]}</td>
                        <td>${data_value[1]}</td>
                        <td>${data_value[2]}</td>
                        <td>${data_value[3]}</td>
                        <td>${data_value[4]}</td>
                        <td>${data.value[5]}</td>
                    </tr>
                `;
                
                tableBody2.innerHTML = tableHTML2;
            }

        }
</script>
</body>