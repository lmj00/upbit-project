{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="{% static 'simulated_trade/css/style.css' %}">
</head>
<body>
    <form id="in_form">
        <div>
            <label for="in_name">이름</label>
            <input type="text" id="in_name" name="in_name"></input>
        </div>
        <div>
            <label for="in_price">가격(KRW)<label>
            <input type="text" id="in_price" name="in_price"></input>
        </div>
        <div>
            <label for="in_quantity">주문수량<label>
            <input type="text" id="in_quantity" name="in_quantity" value="0"></input>
        </div>
        <div>
            <label for="in_total">주문총액(KRW)<label>
            <input type="text" id="in_total" name="in_total" value="0"></input>
        </div>
        <a href="#" id="buyBtn">매수</a>
        <a href="#" id="sellBtn">매도</a>
    </form>
    <div id="market_list" style="cursor: default;"></div>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
        
        function order(event){
            event.preventDefault();
            
            const form = document.getElementById('in_form');
            const formData = new FormData(form);  
            const jsonData = {};


            for (let pair of formData.entries()) {
                jsonData[pair[0]] = pair[1];
            }
            
            const url = event.target.id === 'buyBtn' ? 'order/bid' : 'order/ask'
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken': csrftoken
                },

                body: JSON.stringify(jsonData)
            })

            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
            
            .catch(error => {
                alert("에러");
            });

        };
        
        document.getElementById('buyBtn').addEventListener('click', order);
        document.getElementById('sellBtn').addEventListener('click', order);


        var marketList = document.getElementById('market_list');
        
        // 코인 클릭
        marketList.addEventListener('click', function(event) {
            var target = event.target;
            var code = target.closest('.code');

            if (code) {
                var coinName = code.querySelector('.name').textContent;
                var coinPrice = code.querySelector('.price').textContent;

                var inputName = document.getElementById('in_name');
                inputName.value = coinName;

                var inputPrice = document.getElementById('in_price');
                inputPrice.value = parseFloat(coinPrice);
            }
        });

        // 코인 수량 입력
        var inputQuantity = document.getElementById('in_quantity');
        var inputPrice = document.getElementById('in_price');
        var inputTotal = document.getElementById('in_total');

        inputQuantity.addEventListener('input', function(event) {

            var quantity = parseFloat(event.target.value);
            var price = parseFloat(inputPrice.value);
            var total = quantity * price;

            inputTotal.value = isNaN(total) ? 0 : total.toLocaleString();
        });


        const socket = new WebSocket(
            'ws://' + window.location.host + '/ws/sml_trade/'
        );    

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            for (key in data) {
                var code = document.getElementById(data[key].code);

                if (!code) {
                    var code = document.createElement('div');
                    code.setAttribute('id', data[key].code)
                    code.setAttribute('class', 'code')

                    var name = document.createElement('span');
                    name.setAttribute('class', 'name');
                    name.textContent = data[key].name;

                    var price = document.createElement('span');
                    price.setAttribute('class', 'price');
                    price.textContent= data[key].trade_price;
                        
                    code.appendChild(name);
                    code.appendChild(price);
                    market_list.appendChild(code);
                } else {

                }
            }
        };
</script>
</body>